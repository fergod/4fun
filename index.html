<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ€èƒ½å››å­æ£‹ (è”æœºç‰ˆ)</title>
    <!-- å¼•å…¥ PeerJS åº“ -->
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        .container { max-width: 500px; width: 100%; display: flex; flex-direction: column; align-items: center; }

        /* çŠ¶æ€æ  */
        .status-bar {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .player {
            padding: 10px 20px;
            border-radius: 8px;
            background: #eee;
            opacity: 0.5;
            transition: all 0.3s;
            text-align: center;
            width: 40%;
        }

        .player.active { opacity: 1; transform: scale(1.05); color: white; font-weight: bold; }
        .p1.active { background-color: #0277bd; box-shadow: 0 4px 10px rgba(2,119,189,0.3); }
        .p2.active { background-color: #f9a825; box-shadow: 0 4px 10px rgba(249,168,37,0.3); }

        /* æ£‹ç›˜ */
        #game-board {
            background-color: #0055AA;
            padding: 10px;
            border-radius: 10px;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 380px;
            aspect-ratio: 7/6;
        }

        .cell {
            background-color: #f0f2f5;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            width: 100%;
            padding-bottom: 100%; /* Make it square */
        }

        .piece {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%;
            transform: scale(0.9);
            box-shadow: inset -2px -2px 5px rgba(0,0,0,0.5);
        }
        .black { background: radial-gradient(circle at 30% 30%, #444, #000); }
        .red { background: radial-gradient(circle at 30% 30%, #ff6666, #cc0000); }

        /* é“¾æ¥åŒºåŸŸ */
        #link-area {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            text-align: center;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: none; /* é»˜è®¤éšè—ï¼Œè¿æ¥åæ˜¾ç¤º */
        }
        
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:active { transform: scale(0.98); }

        #message {
            margin-top: 20px;
            font-size: 1.2em;
            font-weight: bold;
            height: 30px;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ² æŠ€èƒ½å››å­æ£‹ (Webç‰ˆ)</h2>

    <div class="status-bar">
        <div id="p1-status" class="player p1 active">
            <div>ç©å®¶ 1</div>
            <small id="p1-label">(ç­‰å¾…ä¸­)</small>
        </div>
        <div id="p2-status" class="player p2">
            <div>ç©å®¶ 2</div>
            <small id="p2-label">(ç­‰å¾…ä¸­)</small>
        </div>
    </div>

    <div id="game-board">
        <!-- JSç”Ÿæˆæ ¼å­ -->
    </div>

    <div id="message">åˆå§‹åŒ–ä¸­...</div>

    <!-- é‚€è¯·é“¾æ¥æ˜¾ç¤ºåŒº -->
    <div id="link-area">
        <p>æŠŠè¿™ä¸ªé“¾æ¥å‘ç»™å¥½å‹ï¼š</p>
        <input type="text" id="invite-link" readonly style="width:100%; padding:8px; margin-bottom:10px; border:1px solid #ddd; border-radius:4px;">
        <button onclick="copyLink()">å¤åˆ¶é“¾æ¥</button>
    </div>
    
    <button id="restart-btn" onclick="requestRestart()" style="display:none; background:#d32f2f;">å†æ¥ä¸€å±€</button>
</div>

<script>
    const rows = 6;
    const cols = 7;
    let board = [];
    let currentPlayer = 1; // 1 or 2
    let myPlayerId = 1;    // æˆ‘æ˜¯ P1 è¿˜æ˜¯ P2
    let gameActive = false;
    let conn = null;       // P2P è¿æ¥å¯¹è±¡
    let peer = null;

    const messageEl = document.getElementById('message');
    const boardEl = document.getElementById('game-board');
    const p1Status = document.getElementById('p1-status');
    const p2Status = document.getElementById('p2-status');
    const linkArea = document.getElementById('link-area');
    const inviteInput = document.getElementById('invite-link');

    // 1. åˆå§‹åŒ–æ£‹ç›˜UI
    function initBoardUI() {
        boardEl.innerHTML = '';
        board = Array(rows).fill().map(() => Array(cols).fill(0));
        for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                cell.onclick = () => handleLocalClick(c);
                cell.dataset.r = r;
                cell.dataset.c = c;
                boardEl.appendChild(cell);
            }
        }
    }

    // 2. å¯åŠ¨ P2P ç½‘ç»œ
    function initNetwork() {
        // è·å– URL ä¸­çš„ id å‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const targetPeerId = urlParams.get('id');

        // åˆ›å»ºæˆ‘çš„ Peer èŠ‚ç‚¹
       // ä¿®æ”¹åçš„ Peer é…ç½®ï¼Œå¢åŠ ç©¿é€èƒ½åŠ›
        peer = new Peer(null, {
            debug: 2,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' }
                ]
            }
        });

        // æ–°å¢ï¼šç›‘å¬è¿æ¥é”™è¯¯ï¼Œç»™ç”¨æˆ·æç¤º
        peer.on('error', (err) => {
            console.error(err);
            if (err.type === 'peer-unavailable') {
                alert("æ‰¾ä¸åˆ°æˆ¿ä¸»ï¼\nå¯èƒ½åŸå› ï¼š\n1. æˆ¿ä¸»å·²ç»å…³é—­äº†é¡µé¢ã€‚\n2. é“¾æ¥å·²è¿‡æœŸã€‚");
            } else if (err.type === 'network' || err.type === 'disconnected') {
                alert("ç½‘ç»œè¿æ¥å¤±è´¥ã€‚\nè¯·å°è¯•ï¼š\n1. åˆ‡æ¢ WiFi/4G ç½‘ç»œ\n2. ç‚¹å‡»å³ä¸Šè§’â€œåœ¨æµè§ˆå™¨æ‰“å¼€â€");
            } else {
                alert("è¿æ¥å‡ºé”™: " + err.type);
            }
        });

        peer.on('open', (id) => {
            console.log('My ID: ' + id);
            
            if (targetPeerId) {
                // === è®¿å®¢æ¨¡å¼ (æˆ‘æ˜¯ P2) ===
                myPlayerId = 2;
                p1Status.querySelector('small').innerText = "(å¯¹æ‰‹)";
                p2Status.querySelector('small').innerText = "(æˆ‘)";
                connectToPeer(targetPeerId);
            } else {
                // === æˆ¿ä¸»æ¨¡å¼ (æˆ‘æ˜¯ P1) ===
                myPlayerId = 1;
                p1Status.querySelector('small').innerText = "(æˆ‘)";
                p2Status.querySelector('small').innerText = "(å¯¹æ‰‹)";
                generateInviteLink(id);
                messageEl.innerText = "è¯·å¤åˆ¶é“¾æ¥é‚€è¯·å¥½å‹ ->";
                linkArea.style.display = 'block';
            }
        });

        // ç›‘å¬è¿æ¥è¯·æ±‚ (æˆ¿ä¸»ç«¯è§¦å‘)
        peer.on('connection', (c) => {
            if (conn) { c.close(); return; } // åªå…è®¸ä¸€ä¸ªäººè¿
            setupConnection(c);
            messageEl.innerText = "å¥½å‹å·²åŠ å…¥ï¼æ¸¸æˆå¼€å§‹";
            linkArea.style.display = 'none';
            gameActive = true;
            updateTurnUI();
        });
    }

    // è¿æ¥åˆ°æˆ¿ä¸»
    function connectToPeer(hostId) {
        messageEl.innerText = "æ­£åœ¨è¿æ¥æˆ¿ä¸»...";
        const c = peer.connect(hostId);
        setupConnection(c);
    }

    // è®¾ç½®è¿æ¥çš„äº‹ä»¶ç›‘å¬
    function setupConnection(c) {
        conn = c;
        
        conn.on('open', () => {
            console.log("Connected!");
            gameActive = true;
            if(myPlayerId === 2) messageEl.innerText = "è¿æ¥æˆåŠŸï¼æ¸¸æˆå¼€å§‹";
            updateTurnUI();
        });

        conn.on('data', (data) => {
            console.log("Received:", data);
            if (data.type === 'move') {
                applyRemoteMove(data);
            } else if (data.type === 'restart') {
                resetGameLocally();
            }
        });

        conn.on('close', () => {
            alert("å¯¹æ–¹å·²æ–­å¼€è¿æ¥");
            gameActive = false;
        });
    }

    // ç”Ÿæˆé‚€è¯·é“¾æ¥
    function generateInviteLink(id) {
        const link = window.location.href.split('?')[0] + '?id=' + id;
        inviteInput.value = link;
    }

    function copyLink() {
        inviteInput.select();
        document.execCommand("copy");
        alert("é“¾æ¥å·²å¤åˆ¶ï¼Œå»å‘ç»™å¾®ä¿¡å¥½å‹å§ï¼");
    }

    // 3. æ¸¸æˆé€»è¾‘
    function handleLocalClick(col) {
        // æ£€æŸ¥ï¼šæ˜¯å¦è¿æ¥ã€æ˜¯å¦ç»“æŸã€æ˜¯å¦è½®åˆ°æˆ‘
        if (!gameActive) return;
        if (currentPlayer !== myPlayerId) {
            messageEl.innerText = "â³ è¿˜æ²¡è½®åˆ°ä½ å‘¢";
            return;
        }

        // è®¡ç®—è½å­ä½ç½®
        let r = -1;
        for (let i = rows - 1; i >= 0; i--) {
            if (board[i][col] === 0) {
                r = i;
                break;
            }
        }
        if (r === -1) return; // åˆ—æ»¡äº†

        // â˜… ç”Ÿæˆéšæœºé¢œè‰² (åªæœ‰ä¸‹æ£‹çš„äººç”Ÿæˆï¼Œç„¶åå‘ç»™å¯¹æ–¹ï¼Œä¿è¯ä¸€è‡´)
        const color = Math.random() < 0.5 ? 1 : 2;

        // æ‰§è¡Œè½å­
        placePiece(r, col, color);

        // å‘é€ç»™å¯¹æ–¹
        conn.send({
            type: 'move',
            row: r,
            col: col,
            color: color
        });
    }

    function applyRemoteMove(data) {
        // æ”¶åˆ°å¯¹æ–¹çš„æ£‹ï¼Œç›´æ¥è½ä¸‹
        placePiece(data.row, data.col, data.color);
    }

    function placePiece(r, c, color) {
        board[r][c] = color;
        
        // åŠ¨ç”»æ¸²æŸ“
        const cell = boardEl.children[r * cols + c];
        const piece = document.createElement('div');
        piece.classList.add('piece', color === 1 ? 'black' : 'red');
        cell.appendChild(piece);

        // æ£€æŸ¥èƒœåˆ©
        if (checkWin(r, c, color)) {
            endGame(color);
        } else {
            // åˆ‡æ¢å›åˆ
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            updateTurnUI();
        }
    }

    function updateTurnUI() {
        if (!gameActive) return;
        
        // ç§»é™¤æ—§çš„çŠ¶æ€
        p1Status.classList.remove('active');
        p2Status.classList.remove('active');

        // æ›´æ–°çŠ¶æ€é«˜äº®
        if (currentPlayer === 1) p1Status.classList.add('active');
        else p2Status.classList.add('active');

        // æ–‡å­—æç¤º
        if (currentPlayer === myPlayerId) {
            messageEl.innerText = "ğŸ”´âš« è½®åˆ°ä½ äº†ï¼ç‚¹å‡»è½å­";
            messageEl.style.color = "#d32f2f";
        } else {
            messageEl.innerText = "â³ å¯¹æ–¹æ€è€ƒä¸­...";
            messageEl.style.color = "#666";
        }
    }

    function checkWin(r, c, color) {
        const directions = [[[0,1],[0,-1]], [[1,0],[-1,0]], [[1,1],[-1,-1]], [[1,-1],[-1,1]]];
        for (let axis of directions) {
            let count = 1;
            for (let dir of axis) {
                let nr = r + dir[0], nc = c + dir[1];
                while (nr >= 0 && nr < rows && nc >= 0 && nc < cols && board[nr][nc] === color) {
                    count++; nr += dir[0]; nc += dir[1];
                }
            }
            if (count >= 4) return true;
        }
        return false;
    }

    function endGame(winningColor) {
        gameActive = false;
        // è°ä¸‹äº†è¿™æ­¥æ£‹ï¼ˆä¹Ÿå°±æ˜¯å½“å‰çš„ currentPlayerï¼‰è°å°±èµ¢
        // æ³¨æ„ï¼šplacePiece é‡Œè¿˜æ²¡åˆ‡æ¢ currentPlayer
        const winnerId = currentPlayer;
        
        let winText = winnerId === 1 ? "ç©å®¶1" : "ç©å®¶2";
        let isMe = winnerId === myPlayerId;
        
        messageEl.innerHTML = `ğŸ‰ <strong>${winText}</strong> è·èƒœï¼${isMe ? "(ä½ èµ¢äº†!)" : "(ä½ è¾“äº†)"}`;
        document.getElementById('restart-btn').style.display = 'block';
    }

    // é‡å¼€é€»è¾‘
    function requestRestart() {
        if(conn) conn.send({ type: 'restart' });
        resetGameLocally();
    }

    function resetGameLocally() {
        initBoardUI();
        currentPlayer = 1;
        gameActive = true;
        document.getElementById('restart-btn').style.display = 'none';
        updateTurnUI();
    }

    // å¯åŠ¨
    initBoardUI();
    initNetwork();

</script>
</body>
</html>
